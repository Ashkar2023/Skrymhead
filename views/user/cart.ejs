<!DOCTYPE html>
<html lang="en">

<head>
	<title>Shoping Cart</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--===============================================================================================-->
	<link rel="icon" type="image/png" href="images/icons/favicon.png" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
	<!--===============================================================================================-->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/perfect-scrollbar/perfect-scrollbar.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="css/util.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/fonts.css">
	<!--===============================================================================================-->
</head>

<body class="animsition">

	<!-- Header -->
	<header>
		<nav class="navbar navbar-expand-md border-bottom fixed-top bg-white border-3 border-black">
			<div class="container-fluid justify-content-around justify-content-md-between ms-lg-5 ms-md-5 me-lg-5">
				<a class="navbar-brand d-flex align-items-center" href="/home">
					<svg width="38" height="48" viewBox="0 0 38 48" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M34 1H4L1 5.63571M34 1L37 5.63571L25 24.1786M34 1L22 19.5429M1 5.63571H25L19 14.9071L16 10.2714M1 5.63571L16 28.8143L4 47.3571M1 5.63571L22 38.0857H16H28L10 10.2714M16 10.2714L28 28.8143M16 10.2714L37 42.7214M22 10.2714H10M10 10.2714L22 28.8143M37 42.7214L34 47.3571H4M37 42.7214H13L19 33.45M4 47.3571L1 42.7214L13 24.1786" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					<h1 class="m-2 text-dark koulen">SKRYMHEAD</h1>
				</a>
	
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
					aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				
				<div class="collapse navbar-collapse me-5" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link" href="/home">Home</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/shop">Shop</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Categories</a>
						</li>
					</ul>
				</div>
				
				
	
				<div class="navbar-text me-5 d-flex">
					<div class="wrap-icon-header flex-w flex-r-m">
						<div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 js-show-modal-search">
							<i class="zmdi zmdi-search"></i>
						</div>
	
						<div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 js-show-account">
							<a href="/profile" style="color:inherit"><i class="zmdi zmdi-account-o"></i></a>
						</div>
	
						<div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti" id="cartNotify" data-notify="<%= cart.items.length %>">
							<a href="/cart"><i class="zmdi zmdi-shopping-cart"></i></a>
						</div>
					</div>
				</div>
			</div>
		</nav>


		<!-- Modal Search -->
		<div class="modal-search-header flex-c-m trans-04 js-hide-modal-search">
			<div class="container-search-header">
				<button class="flex-c-m btn-hide-modal-search trans-04 js-hide-modal-search">
					<img src="images/icons/icon-close2.png" alt="CLOSE">
				</button>

				<form class="wrap-search-header flex-w p-l-15">
					<button class="flex-c-m trans-04">
						<i class="zmdi zmdi-search"></i>
					</button>
					<input class="plh3" type="text" name="search" placeholder="Search...">
				</form>
			</div>
		</div>
	</header>


	<!-- Shoping Cart -->
	<form class="bg0 p-t-75 p-b-85">
		<div class="container mt-5">
			<div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50 ">
					<div class="m-l-25 m-r--38 m-lr-0-xl border border-black">
						<div class="wrap-table-shopping-cart">
							<table class="table-shopping-cart" id="cartTable">
								<thead class="table_head border-bottom border-black">
									<th class="column-1">Product</th>
									<th class="column-2"></th>
									<th class="column-3">Price</th>
									<th class="column-4">Quantity</th>
									<th class="column-5">SubTotal</th>
									<th></th>
								</thead>

								<% let items=cart.items, grandTotal=0; %>
									<% if(items.length===0){ %>
										<tr class="table_row text-center">
											<th>
											<th>
											<th class=" display-5 pe-2">
												<div class="d-flex">
													<i class="bi bi-cart"></i>Cart
												</div></th>
											<th class="display-5 "> empty!</th>
											<th></th>
										</tr>
									<% } %>
										<% items.forEach((item,index)=>{ %>
											<% let image=item.product_id.images[0].url; let { brand,model}=item.product_id; let
												subtotal=item.variant_id.price * item.quantity; grandTotal+=subtotal; %>
												<tr class="table_row" id="row<%= index %>" data-productid="<%= item.product_id._id %>"
													data-updated="no" data-stock="<%= item.variant_id.stock %>">
													
													<td class="column-1">
														<div class="how-itemcart1">
															<img src="/products/<%= brand+' '+model+'/'+image %>" alt="image">
														</div>
													</td>
													<td class="column-2 text-dark fw-bold">
														<%= brand+" "+model %>
														<br><small class=" text-warning fw-normal">Color Selected : </small>
														<div class="btn btn-lg" style="background-color: <%= item.variant_id.color %> ;"></div>
													</td>
													<td class="column-3"><i class="bi bi-currency-rupee"></i>
														<span id="price<%= index %>">
															<%= item.variant_id.price.toLocaleString('en-IN') %>
														</span>
													</td>
													<td class="d-flex justify-content-center m-t-65 align-items-center">
														<div class="row">
															<button type="button" class="btn btn-secondary border col"
																onclick="updatePrice('sub',<%= index %>)">
																<i class="bi bi-dash-lg"></i>
															</button>
															<input readonly class="border col text-center form-control-sm" type="number"
																id="quantity<%= index %>" name="quantity" value="<%= item.quantity %>">
															<button type="button" class="btn btn-secondary border col"
																onclick="updatePrice('add',<%= index %>)">
																<i class="bi bi-plus-lg"></i>
															</button>
														</div>
													</td>
													<td class="column-5">
														<i class="bi bi-currency-rupee" style="font-size: medium;"></i>
														<span id="subtotal<%= index %>" class="fw-bold subtotal">
															<%= subtotal %>
														</span>
													</td>
													<td class="">
														<button class="mx-4" type="button"
															onclick="cartItemDelete('<%= item.variant_id._id %>','<%= index %>')"><i
																class="bi bi-trash"></i></button>
													</td>
												</tr>
									<% }) %>
							</table>
						</div>
					</div>
				</div>

				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
					<div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm border border-black">
						<h4 class="mtext-109 cl2 p-b-30">
							Cart Totals
						</h4>

						<div class="flex-w flex-t bor12 p-b-13">
							<div class="size-208">
								<span class="stext-110 cl2">
									Total:
								</span>
							</div>

							<div class="size-209 d-flex ">
								<i class="bi bi-currency-rupee" style="font-size: medium;"></i>
								<h3 class="fw-bold aling-top" id="grandtotal">
									<%= grandTotal.toLocaleString("en-IN") %>
								</h3>
							</div>
						</div>
						<script>
							function updatePrice(action, index) {
								let quantity = document.getElementById(`quantity${index}`);
								let price = parseInt(document.getElementById(`price${index}`).textContent.replace(/,/g, ""))
								let subtotal = document.getElementById(`subtotal${index}`)
								let data = document.getElementById(`row${index}`);
								const MAX_STOCK  = data.dataset.stock;
								let quantityBE,
									stock = Number(MAX_STOCK);
									console.log(stock)

								if (action === "add" && quantity.value != stock) {
									quantityBE = quantity.value = Number(quantity.value) + 1;
									subtotal.innerHTML = price * quantity.value;
									data.dataset.updated = "yes";
								} else if (action === "sub") {
									if (Number(quantity.value) === 1) {
										Swal.fire({
											icon: 'warning',
											title: 'Invalid Quantity!',
											text: "Quantitiy can't be zero",
											timer: 4000,
											showConfirmButton: true
										});
										quantity.value = 1;
										return;
									} else {
										quantityBE = quantity.value = parseInt(quantity.value, 10) - 1;
										subtotal.textContent = price * quantity.value;
										data.dataset.updated = "yes";
									}
								}else{
									Toastify({
										text:"Maximum quantity reached",
										stopOnfocus:true,
										duration:1500,
										gravity:"top",
										position:"center",
										offset:{
											y:50
										},
										style:{
											backgroundColor: "#ff0000",
										}
									}).showToast();
									return;
								}

								console.log(quantityBE)
								updateGT();
								updateByFetch(index, data, quantityBE);
							}

							function updateGT() {
								let grandTotal = document.getElementById("grandtotal");
								let subtotal = document.querySelectorAll(".subtotal");
								let total = 0;

								subtotal.forEach(sub => {
									total += parseInt(sub.textContent);
								})
								grandTotal.textContent = total.toLocaleString("en-IN");
							}

							function updateByFetch(index, updated, quantityBE) {
								fetch("/updatecart", {
									method: "PATCH",
									headers: {
										"Content-Type": "application/json"
									},
									body: JSON.stringify({
										id: updated.dataset.productid,
										quantity: quantityBE,
										index: index
									})
								})
									.then(response => {
										if (response.ok) {
											return response.json()
										}
									})
									.then(result => {
										console.log(result.success, " : ", result.message);
									})
									.catch(error => {
										console.log(error.message);
									})

							}

							function cartItemDelete(id, index) {
								fetch("/deletecartitem", {
									method: "DELETE",
									headers: {
										"Content-Type": "application/json"
									},
									body: JSON.stringify({
										itemId: id,
										index: index
									})
								})
									.then(response => {
										if (response.ok) {
											return response.json()
										}
									})
									.then(result => {
										if (result.message) {
											console.log(result.message)
											updateCartPage(index, result.length0);
											updateGT();
										} else {
											console.log(result.message)
										}
									})
									.catch(error => {
										console.log(error.message);
									})

								function updateCartPage(index, length0) {
									let row = document.getElementById(`row${index}`);
									row.remove();

									if (length0) {
										let table = document.createElement("tr")
										let emptyInfo = `<td><td>
											<td class="fw-bold display-5 d-flex mt-5 pe-2"><i class="bi bi-cart"></i>Cart</td>
											<td class="fw-bold display-5 "> empty!</td>
											<td></td>`
										table.innerHTML = emptyInfo;
										table.classList.add("table_row", "text-center")
										document.getElementById("cartTable").appendChild(table);
										document.getElementById("grandtotal").textContent = 0;
									}
								}
							}
						</script>
						<div class="d-flex justify-content-center my-3">
								<button class="btn btn-dark py-2 px-5 rounded-pill btn-lg" type="button"
									onclick="goToCheckout(<%= cart.items.length %>)">Proceed to checkout</button>
						</div>
						<script>
							function goToCheckout(length) {
								let grandTotal = document.getElementById("grandtotal").textContent;

								if (length === 0 || (Number(grandTotal) === 0)) {
									Swal.fire({
										title: "Cart empty!",
										icon: "warning",
										timer: 3000,
										showConfirmButton: false
									})
								} else {
									window.location.href = "/checkout";
								}
							}
						</script>
					</div>
				</div>
			</div>
		</div>
	</form>



	<!-- Footer -->
	<%- include("../layouts/footer.ejs") %>



	<!-- Back to top -->
	<div class="btn-back-to-top" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="zmdi zmdi-chevron-up"></i>
		</span>
	</div>

	<!--===============================================================================================-->
	<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/animsition/js/animsition.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<script>
		$(".js-select2").each(function () {
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>
	<!--===============================================================================================-->
	<script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
	<script>
		$('.js-pscroll').each(function () {
			$(this).css('position', 'relative');
			$(this).css('overflow', 'hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function () {
				ps.update();
			})
		});
	</script>
	<!--===============================================================================================-->
	<script src="js/main.js"></script>

</body>

</html>